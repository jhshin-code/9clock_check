<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì¼ ë§ì”€ ì¶œì„ë¶€</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f0f2f5; padding: 20px; text-align: center; }
        
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #pc-login-screen { display: none; max-width: 400px; margin: 50px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }

        h2 { margin-bottom: 10px; color: #333; }
        
        /* ì‹œê³„ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #live-clock { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 5px; letter-spacing: 1px; }
        
        select, input { width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;}
        #excuse-select { border-color: #6c757d; color: #333; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 15px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        
        #attend-btn { background-color: #007bff; }
        #excuse-btn { background-color: #6c757d; }
        #stats-btn { background-color: #17a2b8; margin-top: 20px; width: 100%; }
        #login-btn { background-color: #28a745; margin-top: 10px; width: 100%; }
        
        button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        
        .status-msg { margin: 10px 0 20px 0; font-size: 15px; font-weight: bold; padding: 10px; border-radius: 8px; }
        .gps-status { font-size: 12px; color: #666; margin-bottom: 15px; }
        
        .ok-msg { background-color: #d4edda; color: #155724; }
        .no-msg { background-color: #f8d7da; color: #721c24; }
        .gps-ok { color: #28a745; font-weight: bold; }
        .gps-no { color: #dc3545; font-weight: bold; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 10% auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 10px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
    </style>
</head>
<body>

<div id="pc-login-screen">
    <h2>ğŸ’» PC ì ‘ì† ì œí•œ</h2>
    <p style="color:#666; font-size:14px; margin-bottom:20px;">PCë¡œ ì ‘ì†í•˜ì…¨ìŠµë‹ˆë‹¤.<br>ê´€ë¦¬ì ì ‘ì† ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    <input type="password" id="pc-access-code" placeholder="ì ‘ì† ì½”ë“œ ì…ë ¥">
    <button id="login-btn" onclick="checkPcLogin()">ì ‘ì†í•˜ê¸°</button>
</div>

<div id="main-app" class="container" style="display:none;">
    <h2>ğŸ“ ì£¼ì¼ ë§ì”€ ì¶œì„ë¶€</h2>
    
    <div id="live-clock">00:00:00</div>
    <div id="time-msg" class="status-msg no-msg">ì‹œê°„ í™•ì¸ ì¤‘...</div>
    <div id="gps-msg" class="gps-status">ìœ„ì¹˜ í™•ì¸ ì¤‘...</div>

    <select id="dept-select" onchange="loadNames()"><option value="">ë¶€ì„œ ì„ íƒ</option></select>
    <select id="name-select" disabled><option value="">ì´ë¦„ ì„ íƒ</option></select>

    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

    <select id="excuse-select">
        <option value="">ì‚¬ìœ  ì„ íƒ (ë¯¸ì°¸ì„ ì‹œì—ë§Œ)</option>
        <option value="ì¶œê·¼">ì¶œê·¼</option>
        <option value="ì…ì›">ì…ì›</option>
        <option value="ê²½ì¡°ì‚¬">ê²½ì¡°ì‚¬</option>
        <option value="ì „ë„">ì „ë„</option>
    </select>

    <div class="btn-group">
        <button id="attend-btn" onclick="handleAttendance('attend')" disabled>ì¶œì„ ì²´í¬</button>
        <button id="excuse-btn" onclick="handleAttendance('excuse')" disabled>ì‚¬ìœ  ì œì¶œ</button>
    </div>
    <button id="stats-btn" onclick="openStats()">ğŸ“Š ì¶œì„ ì ìˆ˜ ê·¸ë˜í”„ ë³´ê¸°</button>
</div>

<div id="statsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeStats()">&times;</span>
        <h3>ğŸ“Š ë¶€ì„œë³„ ì¶œì„ ì ìˆ˜ìœ¨</h3>
        <p style="font-size:12px; color:#666; margin-bottom:10px;">09:00 ì´ì „: 100ì  / ì´í›„ ë¶„ë‹¹ -1ì </p>
        <canvas id="myChart"></canvas>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        <h3>ğŸ† ì§€ê° ì—†ëŠ” ì¶œì„ì™•</h3>
        <div id="rank-list" style="text-align: left; background: #f9f9f9; padding: 10px; border-radius: 8px;">ë¡œë”© ì¤‘...</div>
    </div>
</div>

<script>
    // ================= [ì„¤ì • ì˜ì—­] =================
    // â˜… ì£¼ì˜: ìƒˆë¡œ ë°°í¬í•œ ì›¹ ì•± URLì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxwKSzvU5hohYGPRyE2oRsJwU73m7K9U9eBO1xmCHx6jy79E7w0A2xHN7bc-FdF1uZ4/exec"; 
    const TARGET_LAT = 37.195921; 
    const TARGET_LON = 127.101088; 
    const ALLOWED_RADIUS = 300; 
    const PC_ACCESS_PASSWORD = "1324"; 
    // ===============================================

    let membersData = [];
    let isLocationValid = false; 
    let isTimeValid = false; // ì‹œê°„ ìœ íš¨ì„± ì²´í¬ìš©
    let myChart = null;

    window.onload = function() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
            initApp();
        } else {
            document.getElementById('pc-login-screen').style.display = 'block';
            document.getElementById("pc-access-code").addEventListener("keyup", function(event) {
                if (event.key === "Enter") checkPcLogin();
            });
        }
    };

    function checkPcLogin() {
        if (document.getElementById('pc-access-code').value === PC_ACCESS_PASSWORD) {
            document.getElementById('pc-login-screen').style.display = 'none';
            initApp();
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        }
    }

    function initApp() {
        document.getElementById('main-app').style.display = 'block';
        fetchMembers();
        
        // 1ì´ˆë§ˆë‹¤ ì‹œê³„ì™€ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸ (í•µì‹¬ ê¸°ëŠ¥)
        setInterval(updateClockAndStatus, 1000);
        updateClockAndStatus(); // ì¦‰ì‹œ ì‹¤í–‰
        
        // GPSëŠ” 1íšŒ + ë³€í™” ê°ì§€
        checkLocation();
    }

    // [í•µì‹¬] ì‹¤ì‹œê°„ ì‹œê³„ ë° ì‹œê°„ ì œí•œ ë¡œì§
    function updateClockAndStatus() {
        const now = new Date();
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const day = now.getDay(); 
        
        // ì‹œê³„ í‘œì‹œ (ì˜ˆ: 09:05:12)
        const timeString = now.toLocaleTimeString('ko-KR', { hour12: false });
        document.getElementById('live-clock').innerText = timeString;

        // ì‹œê°„ ì œí•œ ë¡œì§ (ì£¼ì¼ 08:30 ~ 09:59:59 ê¹Œì§€) -> 10:00 ë˜ë©´ ë‹«í˜
        const isSunday = (day === 0); 
        const currentMin = now.getHours() * 60 + now.getMinutes();
        const startMin = 8 * 60 + 0; // 08:30
        const endMin = 10 * 60 + 0;   // 10:00

        const msgBox = document.getElementById('time-msg');

        // ì¡°ê±´: ì£¼ì¼ì´ê³ , ì§€ì •ëœ ì‹œê°„ ë²”ìœ„ ë‚´ì¸ê°€?
        if (isSunday && currentMin >= startMin && currentMin < endMin) {
            isTimeValid = true;
            msgBox.innerHTML = "âœ… ì¶œì„ ì²´í¬ ê°€ëŠ¥ ì‹œê°„ì…ë‹ˆë‹¤";
            msgBox.className = "status-msg ok-msg";
        } else {
            isTimeValid = false;
            if (!isSunday) {
                msgBox.innerHTML = "â›” ì˜¤ëŠ˜ì€ ì£¼ì¼ì´ ì•„ë‹™ë‹ˆë‹¤";
            } else if (currentMin < startMin) {
                msgBox.innerHTML = "â›” 08:00 ë¶€í„° ì²´í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤";
            } else {
                msgBox.innerHTML = "â›” ì¶œì„ ë§ˆê° (10:00 ì¢…ë£Œ)";
            }
            msgBox.className = "status-msg no-msg";
        }
        
        checkButtons(); // ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
    }

    function checkLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((position) => {
                const dist = getDistanceFromLatLonInMeters(position.coords.latitude, position.coords.longitude, TARGET_LAT, TARGET_LON);
                const gpsMsg = document.getElementById('gps-msg');
                if (dist <= ALLOWED_RADIUS) {
                    isLocationValid = true;
                    gpsMsg.innerHTML = `<span class="gps-ok">ğŸ“ ìœ„ì¹˜ ì¸ì¦ ì™„ë£Œ (${Math.round(dist)}m)</span>`;
                } else {
                    isLocationValid = false;
                    gpsMsg.innerHTML = `<span class="gps-no">âŒ êµíšŒì™€ ë©‰ë‹ˆë‹¤ (${Math.round(dist)}m)</span>`;
                }
                checkButtons();
            }, () => { isLocationValid = false; }, { enableHighAccuracy: true });
        }
    }

    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = deg2rad(lat2 - lat1); const dLon = deg2rad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * 1000;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    function fetchMembers() {
        fetch(GAS_URL + "?action=getMembers")
        .then(res => res.json())
        .then(data => {
            membersData = data; 
            const depts = [...new Set(data.map(item => item[0]))];
            const deptSelect = document.getElementById('dept-select');
            depts.forEach(dept => {
                const opt = document.createElement('option');
                opt.value = dept; opt.text = dept;
                deptSelect.appendChild(opt);
            });
        });
    }

    function loadNames() {
        const dept = document.getElementById('dept-select').value;
        const nameSelect = document.getElementById('name-select');
        nameSelect.innerHTML = '<option value="">ì´ë¦„ ì„ íƒ</option>';
        nameSelect.disabled = false;
        membersData.filter(r => r[0] === dept).forEach(r => {
            const opt = document.createElement('option');
            opt.value = r[1]; opt.text = r[1];
            nameSelect.appendChild(opt);
        });
        checkButtons();
    }

    // â˜… [ìˆ˜ì •ë¨] 10ë¶„ ì œí•œ ë° ë²„íŠ¼ í™œì„±í™” ê·œì¹™ ì ìš©
    function checkButtons() {
        const attendBtn = document.getElementById('attend-btn');
        const excuseBtn = document.getElementById('excuse-btn');

        // 1. ì¿¨íƒ€ì„(10ë¶„ ì œí•œ) ì²´í¬
        const lastSubmitTime = localStorage.getItem("last_submit_time");
        if (lastSubmitTime) {
            const now = new Date().getTime();
            const diff = now - parseInt(lastSubmitTime);
            const limit = 10 * 60 * 1000; // 10ë¶„

            if (diff < limit) {
                // ì•„ì§ 10ë¶„ì´ ì•ˆ ì§€ë‚¬ìœ¼ë©´ ë¬´ì¡°ê±´ ë¹„í™œì„±í™”
                const minutesLeft = Math.ceil((limit - diff) / (60 * 1000));
                
                attendBtn.disabled = true;
                attendBtn.innerText = `ì œì¶œ ë¶ˆê°€ (${minutesLeft}ë¶„ ë‚¨ìŒ)`;
                
                excuseBtn.disabled = true;
                excuseBtn.innerText = `ì œì¶œ ë¶ˆê°€ (${minutesLeft}ë¶„ ë‚¨ìŒ)`;
                return; // ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ (ì•„ë˜ ë¡œì§ ì‹¤í–‰ ì•ˆ í•¨)
            }
        }

        // ì¿¨íƒ€ì„ì´ ì§€ë‚¬ê±°ë‚˜ ì—†ìœ¼ë©´ ì›ë˜ í…ìŠ¤íŠ¸ë¡œ ë³µêµ¬
        if (attendBtn.innerText.includes("ì œì¶œ ë¶ˆê°€")) {
            attendBtn.innerText = "ì¶œì„ ì²´í¬";
            excuseBtn.innerText = "ì‚¬ìœ  ì œì¶œ";
        }

        // 2. ê¸°ì¡´ ë²„íŠ¼ í™œì„±í™” ë¡œì§ ì‹¤í–‰
        const nameSelected = document.getElementById('name-select').value !== "";
        
        // ì¶œì„ ë²„íŠ¼: [ì´ë¦„ì„ íƒ O] AND [ìœ„ì¹˜ O] AND [ì‹œê°„ O]
        attendBtn.disabled = !(nameSelected && isLocationValid && isTimeValid);
        
        // ì‚¬ìœ  ì œì¶œ: [ì´ë¦„ì„ íƒ O] ì´ë©´ ê°€ëŠ¥ (ì‹œê°„/ìœ„ì¹˜ ìƒê´€ì—†ì´)
        excuseBtn.disabled = !nameSelected;
    }

    function handleAttendance(type) {
        const dept = document.getElementById('dept-select').value;
        const name = document.getElementById('name-select').value;
        const excuseSelect = document.getElementById('excuse-select');
        let note = "ì •ìƒì¶œì„";

        if (type === 'attend') {
            // ì‹œê°„ í•œë²ˆ ë” ì²´í¬ (í•´í‚¹ ë°©ì§€)
            if(!isTimeValid) { alert("ì§€ê¸ˆì€ ì¶œì„ ì²´í¬ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤."); return; }
            if (!confirm(`[${name}]ë‹˜ í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì¶œì„ ì²´í¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        } else if (type === 'excuse') {
            if (excuseSelect.value === "") { alert("ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            if (!confirm(`[${excuseSelect.value}] ì‚¬ìœ ë¡œ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            note = excuseSelect.value;
        }

        // ë²„íŠ¼ ì ê¸ˆ ë° ì „ì†¡ ì¤‘ í‘œì‹œ
        const btnId = type === 'attend' ? 'attend-btn' : 'excuse-btn';
        const btn = document.getElementById(btnId);
        btn.disabled = true;
        btn.innerText = "ì „ì†¡ ì¤‘...";

        fetch(GAS_URL, { 
            method: "POST", 
            mode: "no-cors", // ì¤‘ìš”: Apps Script POST ìš”ì²­ ì‹œ í•„ìˆ˜
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ dept, name, note }) 
        })
        .then(() => { 
            alert("âœ… ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."); 
            
            // â˜… [ì¶”ê°€ë¨] ì„±ê³µ ì‹œ í˜„ì¬ ì‹œê°„ì„ ì €ì¥ (10ë¶„ ì¹´ìš´íŠ¸ ì‹œì‘)
            localStorage.setItem("last_submit_time", new Date().getTime());

            location.reload(); 
        })
        .catch(err => {
            alert("ì „ì†¡ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            console.error(err);
            btn.disabled = false;
            btn.innerText = type === 'attend' ? "ì¶œì„ ì²´í¬" : "ì‚¬ìœ  ì œì¶œ";
        });
    }

    // í†µê³„ ê¸°ëŠ¥
    function openStats() { document.getElementById('statsModal').style.display = "block"; drawStats(); }
    function closeStats() { document.getElementById('statsModal').style.display = "none"; }
    window.onclick = function(event) { if (event.target == document.getElementById('statsModal')) closeStats(); }

    function drawStats() {
        const ctx = document.getElementById('myChart').getContext('2d');
        const rankDiv = document.getElementById('rank-list');
        
        fetch(GAS_URL + "?action=getStats")
        .then(res => res.json())
        .then(data => {
            const stats = data.deptStats;
            const ranks = data.rankList;
            const labels = stats.map(d => d.dept);
            const rates = stats.map(d => d.rate);
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];

            if (myChart) myChart.destroy(); 
            myChart = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¶œì„ ì ìˆ˜ìœ¨(%)',
                        data: rates,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100, ticks: { callback: function(v){return v+"%"} } } },
                    plugins: { legend: { display: false } }
                }
            });

            let html = '<ul style="padding-left: 20px; margin:0;">';
            ranks.forEach((p, index) => {
                let medal = index === 0 ? "ğŸ¥‡" : index === 1 ? "ğŸ¥ˆ" : "ğŸ¥‰";
                if(index > 2) medal = "ğŸ‘";
                html += `<li style="margin-bottom:5px;">${medal} <b>${p.name}</b> : ${p.score}íšŒ</li>`;
            });
            html += '</ul>';
            if(ranks.length === 0) html = "<p>ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            rankDiv.innerHTML = html;
        });
    }
</script>
</body>
</html>
