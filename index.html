<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ìœ„ì¹˜ê¸°ë°˜ ì¶œì„ë¶€</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f0f2f5; padding: 20px; text-align: center; }
        
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ (ì²˜ìŒì—” ìˆ¨ê¹€ ì²˜ë¦¬ ë  ìˆ˜ë„ ìˆìŒ) */
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* PC ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #pc-login-screen { 
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            max-width: 400px; margin: 50px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
        }

        h2 { margin-bottom: 20px; color: #333; }
        select, input { width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;}
        #excuse-select { border-color: #6c757d; color: #333; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 15px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        
        #attend-btn { background-color: #007bff; }
        #excuse-btn { background-color: #6c757d; }
        #stats-btn { background-color: #17a2b8; margin-top: 20px; width: 100%; }
        #login-btn { background-color: #28a745; margin-top: 10px; width: 100%; }
        
        button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        .status-msg { margin: 15px 0; font-size: 14px; font-weight: bold; }
        .gps-status { font-size: 12px; color: #666; margin-bottom: 15px; }
        .ok { color: #28a745; }
        .no { color: #dc3545; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 10% auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 10px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
    </style>
</head>
<body>

<div id="pc-login-screen">
    <h2>ğŸ’» PC ì ‘ì† ì œí•œ</h2>
    <p style="color:#666; font-size:14px; margin-bottom:20px;">PCë¡œ ì ‘ì†í•˜ì…¨ìŠµë‹ˆë‹¤.<br>ê´€ë¦¬ì ì ‘ì† ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    <input type="password" id="pc-access-code" placeholder="ì ‘ì† ì½”ë“œ ì…ë ¥ (ì˜ˆ: 1234)">
    <button id="login-btn" onclick="checkPcLogin()">ì ‘ì†í•˜ê¸°</button>
</div>

<div id="main-app" class="container" style="display:none;">
    <h2>ğŸ“ ìœ„ì¹˜ê¸°ë°˜ ì¶œì„ë¶€</h2>
    <div id="gps-msg" class="gps-status">ìœ„ì¹˜ í™•ì¸ ì¤‘...</div>
    <div id="time-msg" class="status-msg"></div>

    <select id="dept-select" onchange="loadNames()"><option value="">ë¶€ì„œ ì„ íƒ</option></select>
    <select id="name-select" disabled><option value="">ì´ë¦„ ì„ íƒ</option></select>

    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

    <select id="excuse-select">
        <option value="">ì‚¬ìœ  ì„ íƒ (ë¯¸ì°¸ì„ ì‹œì—ë§Œ)</option>
        <option value="ì¶œê·¼">ì¶œê·¼</option>
        <option value="ì…ì›">ì…ì›</option>
        <option value="ê²½ì¡°ì‚¬">ê²½ì¡°ì‚¬</option>
        <option value="ì „ë„">ì „ë„</option>
    </select>

    <div class="btn-group">
        <button id="attend-btn" onclick="handleAttendance('attend')" disabled>ì¶œì„ ì²´í¬</button>
        <button id="excuse-btn" onclick="handleAttendance('excuse')" disabled>ì‚¬ìœ  ì œì¶œ</button>
    </div>
    <button id="stats-btn" onclick="openStats()">ğŸ“Š ì¶œì„ ì ìˆ˜ ê·¸ë˜í”„ ë³´ê¸°</button>
</div>

<div id="statsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeStats()">&times;</span>
        <h3>ğŸ“Š ë¶€ì„œë³„ ì¶œì„ ì ìˆ˜ìœ¨</h3>
        <p style="font-size:12px; color:#666; margin-bottom:10px;">09:00 ì´ì „: 100ì  / ì´í›„ ë¶„ë‹¹ -1ì </p>
        <canvas id="myChart"></canvas>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        <h3>ğŸ† ì§€ê° ì—†ëŠ” ì¶œì„ì™•</h3>
        <div id="rank-list" style="text-align: left; background: #f9f9f9; padding: 10px; border-radius: 8px;">ë¡œë”© ì¤‘...</div>
    </div>
</div>

<script>
    // ================= [ì„¤ì • ì˜ì—­] =================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw1sKmeXDgdGRtl1vReccQYaJG6Jb_suB4QYL_vRyxnOQOGvbAH-OuopFwQo-Xyj66X/exec"; // *** ë°°í¬ëœ URL ì…ë ¥ ***
    const TARGET_LAT = 37.5665; 
    const TARGET_LON = 126.9780; 
    const ALLOWED_RADIUS = 300; 
    
    // [PC ì ‘ì† ë¹„ë°€ë²ˆí˜¸ ì„¤ì •]
    const PC_ACCESS_PASSWORD = "1234"; 
    // ===============================================

    let membersData = [];
    let isLocationValid = false; 
    let myChart = null;

    // ì ‘ì† ì‹œ ì‹¤í–‰
    window.onload = function() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
            // ëª¨ë°”ì¼ì´ë©´ ë°”ë¡œ ì•± ì‹¤í–‰
            initApp();
        } else {
            // PCë©´ ë¡œê·¸ì¸ í™”ë©´ ë„ìš°ê¸°
            document.getElementById('pc-login-screen').style.display = 'block';
            
            // ì—”í„°í‚¤ ì…ë ¥ ì§€ì›
            document.getElementById("pc-access-code").addEventListener("keyup", function(event) {
                if (event.key === "Enter") checkPcLogin();
            });
        }
    };

    // PC ë¡œê·¸ì¸ ì²´í¬ í•¨ìˆ˜
    function checkPcLogin() {
        const inputCode = document.getElementById('pc-access-code').value;
        if (inputCode === PC_ACCESS_PASSWORD) {
            alert("ì ‘ì†ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('pc-login-screen').style.display = 'none';
            initApp(); // ì•± ì‹œì‘
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            document.getElementById('pc-access-code').value = "";
            document.getElementById('pc-access-code').focus();
        }
    }

    // ì•± ì´ˆê¸°í™” ë° ì‹œì‘
    function initApp() {
        document.getElementById('main-app').style.display = 'block'; // ë©”ì¸ í™”ë©´ í‘œì‹œ
        fetchMembers();
        checkTimeAndLocation();
    }

    function fetchMembers() {
        fetch(GAS_URL + "?action=getMembers")
        .then(res => res.json())
        .then(data => {
            membersData = data; 
            const depts = [...new Set(data.map(item => item[0]))];
            const deptSelect = document.getElementById('dept-select');
            depts.forEach(dept => {
                const opt = document.createElement('option');
                opt.value = dept; opt.text = dept;
                deptSelect.appendChild(opt);
            });
        });
    }

    function loadNames() {
        const dept = document.getElementById('dept-select').value;
        const nameSelect = document.getElementById('name-select');
        nameSelect.innerHTML = '<option value="">ì´ë¦„ ì„ íƒ</option>';
        nameSelect.disabled = false;
        membersData.filter(r => r[0] === dept).forEach(r => {
            const opt = document.createElement('option');
            opt.value = r[1]; opt.text = r[1];
            nameSelect.appendChild(opt);
        });
        checkButtons();
    }

    function checkTimeAndLocation() {
        document.getElementById('time-msg').innerHTML = "<span class='ok'>âœ… ì‹œê°„ í™•ì¸ë¨</span>";
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                const dist = getDistanceFromLatLonInMeters(position.coords.latitude, position.coords.longitude, TARGET_LAT, TARGET_LON);
                const gpsMsg = document.getElementById('gps-msg');
                if (dist <= ALLOWED_RADIUS) {
                    isLocationValid = true;
                    gpsMsg.innerHTML = `<span class="ok">ğŸ“ ìœ„ì¹˜ ì¸ì¦ ì™„ë£Œ (${Math.round(dist)}m)</span>`;
                } else {
                    isLocationValid = false;
                    gpsMsg.innerHTML = `<span class="no">âŒ ìœ„ì¹˜ ë¶ˆì¼ì¹˜ (${Math.round(dist)}m)</span>`;
                }
                checkButtons();
            }, () => { isLocationValid = false; checkButtons(); }, { enableHighAccuracy: true });
        }
    }

    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = deg2rad(lat2 - lat1); const dLon = deg2rad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * 1000;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    function checkButtons() {
        const nameSelected = document.getElementById('name-select').value !== "";
        document.getElementById('excuse-btn').disabled = !nameSelected;
        document.getElementById('attend-btn').disabled = !(nameSelected && isLocationValid);
    }

    function handleAttendance(type) {
        const dept = document.getElementById('dept-select').value;
        const name = document.getElementById('name-select').value;
        const excuseSelect = document.getElementById('excuse-select');
        let note = "ì •ìƒì¶œì„";

        if (type === 'attend') {
            if (!confirm(`[${name}]ë‹˜ í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì¶œì„ ì²´í¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        } else if (type === 'excuse') {
            if (excuseSelect.value === "") { alert("ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            if (!confirm(`[${excuseSelect.value}] ì‚¬ìœ ë¡œ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            note = excuseSelect.value;
        }

        document.getElementById('attend-btn').disabled = true;
        document.getElementById('excuse-btn').disabled = true;
        fetch(GAS_URL, { method: "POST", body: JSON.stringify({ dept, name, note }) })
        .then(res => res.json()).then(() => { alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); });
    }

    // ============ [í†µê³„ ë° ê·¸ë˜í”„] ============
    function openStats() { document.getElementById('statsModal').style.display = "block"; drawStats(); }
    function closeStats() { document.getElementById('statsModal').style.display = "none"; }
    window.onclick = function(event) { if (event.target == document.getElementById('statsModal')) closeStats(); }

    function drawStats() {
        const ctx = document.getElementById('myChart').getContext('2d');
        const rankDiv = document.getElementById('rank-list');
        
        fetch(GAS_URL + "?action=getStats")
        .then(res => res.json())
        .then(data => {
            const stats = data.deptStats;
            const ranks = data.rankList;
            const labels = stats.map(d => d.dept);
            const rates = stats.map(d => d.rate);
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];

            if (myChart) myChart.destroy(); 
            myChart = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¶œì„ ì ìˆ˜ìœ¨(%)',
                        data: rates,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100, ticks: { callback: function(v){return v+"%"} } } },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const d = stats[context.dataIndex];
                                    return `${d.rate}% (${d.earned}ì  / ${d.max}ì ) - ì¬ì  ${d.count}ëª…`;
                                }
                            }
                        }
                    }
                }
            });

            let html = '<ul style="padding-left: 20px; margin:0;">';
            ranks.forEach((p, index) => {
                let medal = index === 0 ? "ğŸ¥‡" : index === 1 ? "ğŸ¥ˆ" : "ğŸ¥‰";
                if(index > 2) medal = "ğŸ‘";
                html += `<li style="margin-bottom:5px;">${medal} <b>${p.name}</b> : ${p.score}íšŒ</li>`;
            });
            html += '</ul>';
            if(ranks.length === 0) html = "<p>ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            rankDiv.innerHTML = html;
        });
    }
</script>
</body>
</html>
